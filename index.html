<!DOCTYPE html>
Version 7
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One For Israel - Biblical AI Search</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'israel-blue': '#0038B8',
                        'israel-light': '#F5F8FF',
                        'israel-gold': '#FFD700',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for a more polished look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
        }
        .response-card {
            border-left: 4px solid #0038B8;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .resource-link:hover {
            color: #0038B8;
        }
        .biblical-quote {
            background-color: #FFFBEB; /* Light yellow background */
            border-left: 4px solid #FBBF24; /* Amber/Gold color */
        }
        /* New style to ensure the anchor tag is display:block and takes up space */
        .resource-anchor {
            display: flex; 
            align-items: flex-start; 
            width: 100%; 
            padding-top: 4px; 
            padding-bottom: 4px;
        }
    </style>

    <!-- 
        INTEGRATED CONTENT SECURITY POLICY (CSP) FIXES
        This policy now explicitly allows the necessary external domains for 
        scripts and connections (e.g., Google services) and allows 'blob:' for worker-src.
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: 
            https://www.googletagmanager.com 
            https://www.googleadservices.com 
            https://www.gstatic.com;
        connect-src 'self' blob: data: 
            https://www.googleadservices.com 
            https://firestore.googleapis.com 
            https://auth.firebase.com 
            https://securetoken.googleapis.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        worker-src 'self' blob:;
    ">
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- Header -->
    <header class="w-full container text-center mb-8">
        <h1 class="4xl font-extrabold text-israel-blue">
            <span class="text-israel-gold">One For Israel</span> AI Search
        </h1>
        <p class="text-lg text-gray-600 mt-2">Ask a question about the Bible, Israel, or biblical principles.</p>
        <p id="versionInfo" class="text-sm text-gray-500 mt-1"></p><!-- New element to display version -->
    </header>

    <!-- Main Content Container -->
    <main class="w-full container bg-white p-6 sm:p-8 rounded-xl shadow-2xl">

        <!-- Search Input -->
        <div class="flex flex-col sm:flex-row gap-3 mb-8">
            <input
                id="questionInput"
                type="text"
                placeholder="E.g., What is the significance of the Jewish feast of Tabernacles?"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-israel-blue focus:border-israel-blue"
                onkeypress="if(event.key === 'Enter') document.getElementById('searchButton').click()"
            />
            <button
                id="searchButton"
                onclick="performSearch()"
                class="bg-israel-blue text-white font-semibold py-3 px-6 rounded-lg hover:bg-opacity-90 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50"
            >
                Search
            </button>
        </div>

        <!-- Loading and Error Messages -->
        <div id="statusArea" class="text-center mb-4 min-h-[24px]">
            <div id="loadingIndicator" class="hidden text-israel-blue font-medium flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-israel-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Searching...
            </div>
            <p id="errorMessage" class="hidden text-red-500 font-medium"></p>
        </div>

        <!-- AI Response Area -->
        <div id="responseArea" class="hidden mt-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Response</h2>
            
            <!-- NEW SECTION: One For Israel Analysis -->
            <div id="ofiAnalysisContainer" class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">One For Israel Analysis</h3>
                <div id="ofiAnalysisText" class="response-card bg-israel-light p-5 rounded-lg text-gray-700 leading-relaxed whitespace-pre-wrap">
                    <!-- OFI grounded text will be inserted here -->
                </div>
            </div>

            <!-- NEW SECTION: Biblical Answer -->
            <div id="biblicalAnswerContainer">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Answer from the Bible</h3>
                <div id="biblicalAnswerText" class="response-card bg-israel-light p-5 rounded-lg text-gray-700 leading-relaxed whitespace-pre-wrap">
                    <!-- Biblical answer text (including styled quote) will be inserted here -->
                </div>
            </div>
            
            <div id="resources" class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Suggested Resources</h3>
                <div id="resourceList" class="space-y-3">
                    <!-- Resource links will be inserted here -->
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        // Gemini API Configuration
        const apiKey = "AIzaSyBfiUej4RdpnMF09qMR3B93ysstdL2cFlg"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Define the current app version
        const appVersion = "1.0.5"; // Updated version after structural link fix

        /**
         * Utility functions (kept for completeness but not currently used for TTS)
         */
        const base64ToArrayBuffer = (base64) => { /* ... */ };
        const pcmToWav = (pcm16, sampleRate) => { /* ... */ };

        const questionInput = document.getElementById('questionInput');
        const searchButton = document.getElementById('searchButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const responseArea = document.getElementById('responseArea');
        
        // --- UPDATED TARGET ELEMENTS ---
        const ofiAnalysisTextDiv = document.getElementById('ofiAnalysisText');
        const biblicalAnswerTextDiv = document.getElementById('biblicalAnswerText');
        
        const resourceList = document.getElementById('resourceList');

        /**
         * Performs the search against the Gemini API.
         * Includes exponential backoff for retries.
         */
        window.performSearch = async function() {
            const rawUserQuery = questionInput.value.trim();
            if (!rawUserQuery) {
                errorMessage.textContent = "Please enter a question to search.";
                errorMessage.classList.remove('hidden');
                return;
            }

            // --- CRITICAL CHANGE: Prepends filter for both website AND YouTube channel ---
            const domainFilter = "site:www.oneforisrael.org OR site:youtube.com/@OneforIsrael"; 
            const processedQuery = `${domainFilter} ${rawUserQuery}`;

            // Reset UI states
            errorMessage.classList.add('hidden');
            responseArea.classList.add('hidden');
            ofiAnalysisTextDiv.innerHTML = ''; // Reset new elements
            biblicalAnswerTextDiv.innerHTML = ''; // Reset new elements
            resourceList.innerHTML = '';
            searchButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            // --- UPDATED SYSTEM PROMPT: Enforcing structured two-part response ---
            const systemPrompt = `Crucial Instruction: If the user's question is *not* related to the Bible, biblical principles, or the nation of Israel, you MUST respond politely by stating, 'I am only specialized in answering questions about the Bible, biblical principles, and the ministry of One For Israel, using content exclusively from www.oneforisrael.org and its official YouTube channel. Please try a different, related question.' Do not attempt to answer off-topic questions.

            You are a helpful AI assistant specialized in the Bible, biblical principles, and the content of the 'one for israel' ministry. Your entire response MUST be structured in two mandatory parts, using the delimiters:

            1.  **---OFI\_ANALYSIS---**: The answer based on content found on www.oneforisrael.org or its YouTube channel.
            2.  **---BIBLICAL\_ANSWER---**: A direct answer derived *only* from scripture, including a relevant biblical quotation (KJV preferred).

            Your response must strictly follow this format (do not include the title line in the output):
            ---OFI_ANALYSIS---
            [Analysis text grounded in search results. Address personnel roles if relevant.]
            ---BIBLICAL_ANSWER---
            [Scripture-based answer. Include the Bible verse formatted as a blockquote within this section, e.g., "Scripture text." - Book Chapter:Verse]
            `;

            const payload = {
                contents: [{ parts: [{ text: processedQuery }] }], // Use the processed query with the combined site filter
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let response = null;
            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Check if the API key is present before fetching
                    if (!apiKey && window.location.protocol.startsWith('http')) {
                         throw new Error("API Key is missing for external deployment.");
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Retry with exponential backoff for rate limiting
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        // Throw error to be caught below
                        const errorBody = await response.text();
                        throw new Error(`API returned status ${response.status}: ${errorBody.substring(0, 100)}...`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1 || error.message.includes("API Key is missing")) {
                        console.error('API call failed after all retries or due to missing key:', error);
                        // Provide more specific feedback if the key is missing on a hosted environment
                        if (!apiKey && window.location.protocol.startsWith('http')) {
                            errorMessage.textContent = 'API Key Error: Please insert your Gemini API key in the index.html file to run this on a public web server.';
                        } else {
                            errorMessage.textContent = 'An error occurred while communicating with the AI. Please try again later.';
                        }
                        
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            try {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            // --- SOURCE FILTERING: Accept links from both website and YouTube ---
                            .filter(source => source.uri && source.title && 
                                (source.uri.includes('oneforisrael.org') || source.uri.includes('youtube.com'))); 
                    }

                    displayResults(text, sources);

                } else {
                    errorMessage.textContent = 'AI could not generate a response for that query.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error processing API response:', e);
                errorMessage.textContent = 'Error processing the AI response data.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                searchButton.disabled = false;
            }
        };

        /**
         * Renders the AI's text and the grounding sources (links).
         * Now parses the two distinct sections (OFI Analysis and Biblical Answer)
         * @param {string} text The generated text from the AI.
         * @param {Array<{uri: string, title: string}>} sources Array of grounding sources.
         */
        function displayResults(text, sources) {
            // --- PARSING LOGIC: Split the response based on the mandatory delimiters ---
            const parts = text.split('---BIBLICAL_ANSWER---');
            let ofiAnalysis = parts[0];
            let biblicalAnswer = parts.length > 1 ? parts[1] : '';

            // Clean up the OFI Analysis part (remove its starting delimiter if present)
            if (ofiAnalysis.startsWith('---OFI_ANALYSIS---')) {
                ofiAnalysis = ofiAnalysis.substring('---OFI_ANALYSIS---'.length).trim();
            }

            // --- Styling the Biblical Quote within the Biblical Answer Section ---
            const verseRegex = /(".*?"\s*-\s*[^.\n]*)/s;
            const verseMatch = biblicalAnswer.match(verseRegex);
            
            let formattedBiblicalAnswer = biblicalAnswer;

            if (verseMatch) {
                const verseBlock = verseMatch[0];
                const styledVerse = `<div class="biblical-quote p-4 rounded-md italic mt-4 mb-4 text-gray-800">${verseBlock}</div>`;
                // Replace the plain text verse block with the styled HTML
                formattedBiblicalAnswer = biblicalAnswer.replace(verseBlock, styledVerse);
            }
            
            // Replace newlines with <br> for better presentation in both sections
            const formattedOFIAnalysis = ofiAnalysis.replace(/\n/g, '<br>');
            formattedBiblicalAnswer = formattedBiblicalAnswer.replace(/\n/g, '<br>');


            // Render the split results
            ofiAnalysisTextDiv.innerHTML = formattedOFIAnalysis;
            biblicalAnswerTextDiv.innerHTML = formattedBiblicalAnswer;
            
            // Render Resources
            resourceList.innerHTML = '';
            if (sources.length > 0) {
                sources.forEach((source) => {
                    // Determine if it's a video icon or article icon
                    const icon = source.uri.includes('youtube.com') ? 
                        `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>` :
                        `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-israel-gold mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>`;

                    // Create the <a> element directly and append it.
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = "_blank";
                    link.className = "resource-link resource-anchor text-gray-700 hover:underline transition duration-150";
                    
                    // Set the inner HTML of the <a> tag
                    link.innerHTML = `
                        ${icon}
                        <div>
                            <span class="font-medium">${source.title}</span> 
                            <span class="text-sm text-gray-500 block sm:inline">(${source.uri})</span>
                        </div>
                    `;

                    // Append the complete <a> element to the list container
                    resourceList.appendChild(link);
                });
            } else {
                resourceList.innerHTML = '<p class="text-gray-500">No specific resources from www.oneforisrael.org or its YouTube channel were found via search grounding for this query.</p>';
            }

            responseArea.classList.remove('hidden');
        }

        // Set focus on input when page loads
        window.onload = () => {
            questionInput.focus();
            // Display the app version
            document.getElementById('versionInfo').textContent = `Version ${appVersion}`;
        };
    </script>
</body>
</html>
